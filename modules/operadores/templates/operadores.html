{% extends 'base.html' %}

{% block content %}
<div class="max-w-7xl mx-auto p-6">

    {# --- SECCIÓN DE MENSAJES (FLASH) --- #}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="mb-8 space-y-3">
                {% for category, message in messages %}
                    <div class="flex items-center p-4 rounded-lg border shadow-sm transition-all duration-300
                        {{ 'bg-yellow-50 border-yellow-200 text-yellow-800' if category == 'warning'
                           else ('bg-red-50 border-red-200 text-red-800' if category == 'error'
                           else 'bg-green-50 border-green-200 text-green-800') }}">
                        <span class="material-symbols-outlined mr-3">
                            {{ 'warning' if category in ['error', 'warning'] else 'check_circle' }}
                        </span>
                        <span class="text-sm font-medium">{{ message }}</span>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

        <div class="lg:col-span-1">
            <div class="bg-white rounded-xl shadow-md border border-gray-100 overflow-hidden sticky top-6">
                <div class="p-6 border-b border-gray-100 bg-gray-50">
                    <h2 class="text-lg font-bold text-gray-800 flex items-center">
                        <span class="material-symbols-outlined mr-2 text-indigo-600">manage_accounts</span>
                        Gestión de Operador
                    </h2>
                    <p class="text-xs text-gray-500 mt-1">Selecciona un usuario para comenzar</p>
                </div>

                <div class="p-6 space-y-6">
                    <div>
                        <label for="master-usuario" class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">
                            Usuario
                        </label>
                        <select id="master-usuario" class="w-full bg-white border border-gray-300 text-gray-700 py-2 px-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-shadow">
                            <option selected disabled value="">-- Seleccione Usuario --</option>
                            {% for u in usuarios %}
                                <option value="{{ u.id }}">{{ u.usuario }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <hr class="border-gray-100">

                    <div class="opacity-50 pointer-events-none transition-all duration-300" id="bloque-franquicia">
                        <label for="select-franquicia" class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">
                            Gestionar Franquicia
                        </label>
                        <select id="select-franquicia" class="w-full bg-white border border-gray-300 text-gray-700 py-2 px-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent mb-4">
                            <option selected disabled value="">-- Seleccione Franquicia --</option>
                            {% for f in franquicias %}
                                <option value="{{ f.id }}">{{ f.razon_social }}</option>
                            {% endfor %}
                        </select>

                        <div id="status-area" class="hidden">
                            <div class="flex justify-between items-center mb-3">
                                <span class="text-sm text-gray-600">Estado actual:</span>
                                <span id="status-badge" class="px-2 py-1 text-xs font-bold rounded-full"></span>
                            </div>

                            <button id="estado_accion_btn" class="w-full py-2.5 px-4 rounded-lg font-semibold text-white shadow-md transition-all duration-200 transform hover:-translate-y-0.5 flex justify-center items-center">
                                </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="lg:col-span-2">
            <div class="bg-white rounded-xl shadow-md border border-gray-100 overflow-hidden min-h-[400px]">
                <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                    <h3 class="text-lg font-bold text-gray-800 flex items-center">
                        <span class="material-symbols-outlined mr-2 text-indigo-600">list_alt</span>
                        Franquicias Asignadas
                    </h3>
                    <span class="bg-indigo-50 text-indigo-700 text-xs font-bold px-3 py-1 rounded-full" id="count-badge">
                        0 asignadas
                    </span>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-50 text-gray-600 text-xs uppercase tracking-wider">
                                <th class="p-4 font-semibold border-b border-gray-200">ID (UUID)</th>
                                <th class="p-4 font-semibold border-b border-gray-200">CUIT</th>
                                <th class="p-4 font-semibold border-b border-gray-200">Razón Social</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-franquicias" class="text-sm text-gray-700 divide-y divide-gray-100">
                            <tr>
                                <td colspan="3" class="p-10 text-center text-gray-400">
                                    <div class="flex flex-col items-center justify-center">
                                        <span class="material-symbols-outlined text-4xl mb-2">touch_app</span>
                                        <p>Seleccione un usuario en el panel izquierdo para ver sus franquicias.</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Referencias a elementos del DOM
    const masterUserSelect = document.getElementById('master-usuario');
    const bloqueFranquicia = document.getElementById('bloque-franquicia');
    const selectFranquicia = document.getElementById('select-franquicia');
    const statusArea = document.getElementById('status-area');
    const statusBadge = document.getElementById('status-badge');
    const actionBtn = document.getElementById('estado_accion_btn');
    const tbody = document.getElementById('tbody-franquicias');
    const countBadge = document.getElementById('count-badge');

    // --- 1. CUANDO CAMBIA EL USUARIO ---
    masterUserSelect.addEventListener('change', function() {
        const userId = this.value;
        if (!userId) return;

        // A. Activamos visualmente el bloque de franquicias
        bloqueFranquicia.classList.remove('opacity-50', 'pointer-events-none');

        // B. Reseteamos la selección de franquicia y ocultamos acciones previas
        selectFranquicia.value = "";
        statusArea.classList.add('hidden');

        // C. Cargamos la tabla (Lógica original mejorada)
        cargarTabla(userId);
    });

    // --- 2. CUANDO CAMBIA LA FRANQUICIA (AUTO CHECK) ---
    selectFranquicia.addEventListener('change', function() {
        const franId = this.value;
        const userId = masterUserSelect.value;

        if (!userId || !franId) return;

        // Llamada automática para verificar estado
        checkEstado(userId, franId);
    });

    // --- 3. CLICK EN EL BOTÓN DE ACCIÓN (POST) ---
    actionBtn.addEventListener('click', function(e) {
        e.preventDefault();
        const userId = masterUserSelect.value;
        const franId = selectFranquicia.value;

        // Creamos y enviamos el form
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/operadores/modificar-status';

        const inputUsu = document.createElement('input');
        inputUsu.type = 'hidden';
        inputUsu.name = 'id_usuario';
        inputUsu.value = userId;

        const inputFran = document.createElement('input');
        inputFran.type = 'hidden';
        inputFran.name = 'id_franquicia';
        inputFran.value = franId;

        form.appendChild(inputUsu);
        form.appendChild(inputFran);
        document.body.appendChild(form);
        form.submit();
    });

    // --- FUNCIONES AUXILIARES ---

    function cargarTabla(userId) {
        tbody.innerHTML = '<tr><td colspan="3" class="p-8 text-center text-indigo-500 animate-pulse">Cargando datos...</td></tr>';

        fetch(`/operadores/franquicias/${userId}`)
            .then(res => res.json())
            .then(data => {
                tbody.innerHTML = ''; // Limpiar
                countBadge.innerText = `${data.length} asignadas`;

                if (data.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="3" class="p-8 text-center">
                                <div class="bg-gray-50 rounded-lg p-4 inline-block">
                                    <p class="text-gray-500">Este usuario no tiene franquicias activas.</p>
                                </div>
                            </td>
                        </tr>`;
                    return;
                }

                data.forEach(f => {
                    const row = `
                        <tr class="hover:bg-indigo-50 transition-colors">
                            <td class="p-4 font-mono text-xs text-gray-500 select-all">${f.id}</td>
                            <td class="p-4 font-medium text-gray-800">${f.cuit}</td>
                            <td class="p-4 font-semibold text-gray-700">${f.razon_social}</td>
                        </tr>
                    `;
                    tbody.insertAdjacentHTML('beforeend', row);
                });
            })
            .catch(err => {
                console.error(err);
                tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-red-500">Error al cargar listado.</td></tr>';
            });
    }

    function checkEstado(userId, franId) {
        // Feedback de carga en el botón
        statusArea.classList.remove('hidden');
        actionBtn.innerText = "Verificando...";
        actionBtn.className = "w-full py-2.5 px-4 rounded-lg font-semibold text-gray-500 bg-gray-200 cursor-not-allowed";
        statusBadge.className = "hidden"; // Ocultar badge temporalmente

        fetch(`/operadores/es-operador/check?id_usuario=${userId}&id_franquicia=${franId}`)
            .then(res => res.json())
            .then(data => {
                statusBadge.classList.remove('hidden');

                // Clases base del botón
                const btnBase = "w-full py-2.5 px-4 rounded-lg font-semibold text-white shadow-md transition-all duration-200 transform hover:-translate-y-0.5 flex justify-center items-center";

                if (data.es_operador) {
                    // ESTADO: ASOCIADO -> Mostrar Desasociar
                    statusBadge.innerText = "ASOCIADO";
                    statusBadge.className = "px-2 py-1 text-xs font-bold rounded-full bg-green-100 text-green-700 border border-green-200";

                    actionBtn.innerHTML = '<span class="material-symbols-outlined text-sm mr-2">link_off</span> Desasociar Franquicia';
                    actionBtn.className = `${btnBase} bg-red-500 hover:bg-red-600 border border-red-600`;
                    actionBtn.value = "desasociar";
                } else {
                    // ESTADO: NO ASOCIADO -> Mostrar Asociar
                    statusBadge.innerText = "NO ASOCIADO";
                    statusBadge.className = "px-2 py-1 text-xs font-bold rounded-full bg-gray-100 text-gray-600 border border-gray-200";

                    actionBtn.innerHTML = '<span class="material-symbols-outlined text-sm mr-2">link</span> Asociar Franquicia';
                    actionBtn.className = `${btnBase} bg-indigo-600 hover:bg-indigo-700 border border-indigo-700`;
                    actionBtn.value = "asociar";
                }
            })
            .catch(err => {
                console.error(err);
                actionBtn.innerText = "Error de conexión";
            });
    }
</script>
{% endblock %}