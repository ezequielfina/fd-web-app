{% extends 'base.html' %}

{% block content %}
<div class="max-w-4xl mx-auto p-6">
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-800">{{ module }}</h1>
            <p class="text-gray-500">Selecciona una franquicia y luego una carga para ver sus detalles.</p>
        </div>
        <button id="btn-global-refresh" onclick="refreshCurrentLoad()"
            class="inline-flex items-center px-4 py-2 bg-white border border-gray-300 hover:bg-indigo-50 hover:text-indigo-700 text-gray-700 text-sm font-medium rounded-lg transition-all shadow-sm active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
            <svg id="icon-refresh" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 transition-transform duration-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            Actualizar Estado
        </button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-white rounded-xl shadow-md border border-gray-100 p-6 mb-8">

        <div>
            <label for="id_franquicia" class="block text-sm font-semibold text-gray-700 mb-2">1. Franquicia</label>
            <div class="relative">
                <select id="id_franquicia" onchange="cargarCargas()"
                    class="block w-full pl-3 pr-10 py-3 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-lg border appearance-none transition-all cursor-pointer">
                    <option selected disabled value="">-- Seleccione Franquicia --</option>
                    {% for f in franquicias %}
                        <option value="{{ f.id }}">{{ f.razon_social }} ({{ f.cuit }})</option>
                    {% endfor %}
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400">
                    <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                </div>
            </div>
        </div>

        <div>
            <label for="id_carga" class="block text-sm font-semibold text-gray-700 mb-2">2. Carga</label>
            <div class="relative">
                <select id="id_carga" onchange="updateDetails()" disabled
                    class="block w-full pl-3 pr-10 py-3 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-lg border appearance-none transition-all cursor-pointer disabled:bg-gray-100 disabled:text-gray-400">
                    <option selected disabled value="">-- Primero seleccione Franquicia --</option>
                </select>

                <div id="spinner-carga" class="hidden absolute inset-y-0 right-8 flex items-center">
                    <svg class="animate-spin h-4 w-4 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>

                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400">
                    <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                </div>
            </div>
        </div>
    </div>

    <div id="detalle-container" class="hidden animate-fade-in">
        <div class="bg-white shadow-xl rounded-2xl overflow-hidden border border-gray-100">
            <div id="status-banner" class="px-6 py-4 flex justify-between items-center border-b">
                <h3 class="text-lg font-bold text-gray-800" id="detail-filename">archivo.csv</h3>
                <span id="detail-status" class="px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider"></span>
            </div>

            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-4">
                    <div>
                        <p class="text-xs text-gray-400 uppercase font-bold tracking-widest">ID de Carga</p>
                        <p class="text-sm font-mono text-gray-700" id="detail-id"></p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-400 uppercase font-bold tracking-widest">Periodo</p>
                        <p class="text-gray-700 font-medium" id="detail-periodo"></p>
                    </div>
                </div>

                <div class="space-y-4">
                    <div>
                        <p class="text-xs text-gray-400 uppercase font-bold tracking-widest">Fecha de Carga</p>
                        <p class="text-gray-700 font-medium" id="detail-fecha"></p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-400 uppercase font-bold tracking-widest">Última Actualización</p>
                        <p class="text-gray-700 font-medium" id="detail-ult-fecha"></p>
                    </div>
                </div>
            </div>

            <div class="bg-gray-50 px-6 py-4 text-xs text-gray-400 italic" id="detail-point">
                </div>
        </div>
    </div>

    <div id="loading" class="hidden flex justify-center py-10">
        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600"></div>
    </div>
</div>

<script>
async function refreshCurrentLoad() {
    const select = document.getElementById('id_carga');
    const btnIcon = document.getElementById('icon-refresh');

    // 1. Validar que haya algo seleccionado
    if (!select.value || select.value.startsWith("--")) {
        alert("Por favor, seleccione una carga primero.");
        return;
    }

    // 2. Animación visual del botón (Girar icono)
    btnIcon.classList.add('animate-spin'); // Clase de Tailwind para girar

    // 3. Llamar a la lógica de actualización existente
    // Usamos await para esperar a que termine antes de quitar la animación
    await updateDetails();

    // 4. Quitar animación (con un pequeño timeout para que se note si es muy rápido)
    setTimeout(() => {
        btnIcon.classList.remove('animate-spin');
    }, 500);
}

// --- FUNCIÓN 1: Cargar el Select de Cargas cuando cambia la Franquicia ---
async function cargarCargas() {
    const idFranq = document.getElementById('id_franquicia').value;
    const selectCarga = document.getElementById('id_carga');
    const spinnerCarga = document.getElementById('spinner-carga');
    const detalleContainer = document.getElementById('detalle-container');

    // Resetear UI
    selectCarga.innerHTML = '<option selected disabled>Cargando...</option>';
    selectCarga.disabled = true;
    spinnerCarga.classList.remove('hidden');
    detalleContainer.classList.add('hidden'); // Ocultar detalles viejos

    try {
        // Llamada al endpoint: /cargas/cargas/<uuid:id_franq>
        const response = await fetch(`/cargas/cargas/${idFranq}`);

        if (!response.ok) throw new Error("Error en red");

        const cargas = await response.json();

        // Limpiar y llenar select
        selectCarga.innerHTML = '<option selected disabled value="">-- Seleccione una Carga --</option>';

        if (cargas.length === 0) {
            selectCarga.innerHTML += '<option disabled>No hay cargas para esta franquicia</option>';
        } else {
            cargas.forEach(c => {
                const option = document.createElement('option');
                option.value = c.id;
                // Ajusta aquí qué quieres mostrar en el texto del option
                option.text = `${c.periodo} | ${c.nombre_archivo} (${c.status})`;
                selectCarga.appendChild(option);
            });
            selectCarga.disabled = false;
        }

    } catch (error) {
        console.error("Error cargando cargas:", error);
        selectCarga.innerHTML = '<option selected disabled>Error al cargar</option>';
    } finally {
        spinnerCarga.classList.add('hidden');
    }
}

// --- FUNCIÓN 2: Mostrar detalles cuando se selecciona una Carga ---
async function updateDetails() {
    const select = document.getElementById('id_carga');
    const id = select.value;
    if (!id || id.startsWith("--")) return;

    const container = document.getElementById('detalle-container');
    const loading = document.getElementById('loading');

    loading.classList.remove('hidden');
    container.classList.add('hidden'); // Ocultar mientras carga nuevo

    try {
        // Llamada al endpoint: /cargas/<uuid:id_carga>
        const response = await fetch(`/cargas/${id}`);
        const data = await response.json();

        const statusStyles = {
            'LOADED': 'bg-green-100 text-green-700 border-green-200',
            'RAW': 'bg-blue-100 text-blue-700 border-blue-200',
            'VALIDATED': 'bg-purple-100 text-purple-700 border-purple-200',
            'TRANSFORMED': 'bg-indigo-100 text-indigo-700 border-indigo-200',
            'FAILED': 'bg-red-100 text-red-700 border-red-200'
        };

        document.getElementById('detail-filename').textContent = data.nombre_archivo;
        document.getElementById('detail-id').textContent = data.id;
        document.getElementById('detail-periodo').textContent = data.periodo;
        document.getElementById('detail-fecha').textContent = new Date(data.fecha_carga).toLocaleString();
        document.getElementById('detail-ult-fecha').textContent = new Date(data.ult_fecha_status).toLocaleString();

        // Manejo seguro del objeto anidado o ID simple
        const pvText = data.punto_venta ?
                       `${data.punto_venta.descripcion} (ID: ${data.id_punto_venta})` :
                       `Punto de Venta ID: ${data.id_punto_venta}`;

        document.getElementById('detail-point').textContent = pvText;

        const statusLabel = document.getElementById('detail-status');
        statusLabel.textContent = data.status;

        statusLabel.className = "px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider " +
            (data.status.includes('FAILED') ? statusStyles['FAILED'] : (statusStyles[data.status] || 'bg-gray-100 text-gray-700'));

        container.classList.remove('hidden');
        container.classList.add('animate-fade-in');

    } catch (error) {
        console.error("Error al obtener detalles:", error);
        alert("No se pudo obtener la información de la carga.");
    } finally {
        loading.classList.add('hidden');
    }
}
</script>

<style>
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
.animate-fade-in {
    animation: fadeIn 0.4s ease-out forwards;
}
</style>
{% endblock %}